version: 2.1

commands:
  install-kubectl:
    description: install kubectl
    steps:
      - run:
          name: Installing kubectl
          command: |
                  yum install tar gzip -y
                  curl --silent --location -o /usr/local/bin/kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl
                  chmod +x /usr/local/bin/kubectl
                  mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$PATH:$HOME/bin
                  kubectl version --client
          
                  # curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
                  # mv /tmp/eksctl /usr/local/bin
                  # eksctl version
jobs:
  test-backend:
    docker:
      - image: cimg/python:3.10.1
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            pip install -r requirements.txt
      - run:
          name: run tests
          command: |
            python manage.py test

  build-backend-image:
    docker:
      - image: cimg/python:3.10.1
    steps:
      - checkout
      # - setup_remote_docker:
      #     docker_layer_caching: false
      - run:
        name: Build backend image
        command: |
          docker build -t djangoBackend -t paularinze/djangoBackend:latest .
          echo $DOCKER_PASSWORD | docker login -u paularinze --password-stdin
          docker push paularinze/djangoBackend:latest

  # plan-apply:
  #   working_directory: /tmp/project
  #   docker:
  #     - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
  #   steps:
  #     - checkout
  #     - run:
  #         name: terraform init & plan
  #         command: |
  #           terraform init -input=false
  #           terraform plan -out tfapply -var-file terraform.tfvars
  #     - persist_to_workspace:
  #         root: .
  #         paths:
  #           - .
  # apply:
  #   docker:
  #     - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
  #   steps:
  #     - attach_workspace:
  #         at: .
  #     - run:
  #         name: terraform
  #         command: |
  #           terraform apply -auto-approve tfapply
  #     - persist_to_workspace:
  #         root: .
  #         paths:
  #           - .
# deploy:
#     docker:
#       - image: amazon/aws-cli
#     steps:
#       - checkout
#       - install-kubectl
#       - run:
#           name: Deploying version_1
#           command: |
#               kubectl apply -f deployment.yml
#               kubectl apply -f service.yml
#       - destroy-cluster
workflows:
  the_jobs:
    jobs:
      - test-backend
      - build-backend-image
      # - build-backend-image:
      #     requires: [test-backend]
      # - plan-apply
      # - hold-apply:
      #     type: approval
      #     requires:
      #       - plan-apply
      # - apply:
      #     requires:
      #       - hold-apply

      # # - deploy
      #     requires:
      #      - bulid-frontend_image
      #      - build-backend-image
      #      - hold-apply
    
    
    
    
  